name: Build, Test, Scan and Push to ECR

on:
  push:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python environment (for tests)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # 4Ô∏è‚É£ Run automated tests
      - name: Run Unit Tests
        run: |
          if [ -d tests ]; then
            pytest tests/ --maxfail=1 --disable-warnings -q
          else
            echo "No tests folder found, skipping tests."
          fi

      # 5Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6Ô∏è‚É£ Login to Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 7Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t query_app:latest .

      # 8Ô∏è‚É£ Run Trivy Security Scan
      - name: Security Scan with Trivy
        uses: aquasecurity/trivy-action@0.11.2
        with:
          image-ref: query_app:latest
          format: 'table'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      # 9Ô∏è‚É£ Tag and push Docker image to Amazon ECR
      - name: Tag and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: query_app_apsoutheast
          IMAGE_TAG: dev-${{ github.run_number }}
        run: |
          docker tag query_app:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # üîü Confirm push success
      - name: Image pushed successfully
        run: echo "‚úÖ Image pushed to ECR as ${{ steps.login-ecr.outputs.registry }}/query_app_apsoutheast:dev-${{ github.run_number }}"
